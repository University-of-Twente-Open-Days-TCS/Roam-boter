<!DOCTYPE html>
<html>
<head>
    <script src="https://unpkg.com/konva@4.1.5/konva.min.js"></script>
</head>
<body>
<div id="container"></div>
<script>
    // first we need to create a stage
    var stage = new Konva.Stage({
        container: 'container',   // id of container <div>
        width: 500,
        height: 500
    });

    // then create layer
    var layer = new Konva.Layer();
    var templayer = new Konva.Layer();
    spacing = 40;
    line_height = 10;
    class condition {

        constructor() {

            this.height = spacing;

            //TODO: change
            this.width = 100;
            this.makeGroup();
        }

        makeGroup() {
            var g = new Konva.Group({
                draggable:true
            });
            var rect1 = new Konva.Rect({
                x: 0,
                y: 0,
                width: this.width,
                height: this.height,
                fill: 'blue',
                stroke: 'black',
                strokeWidth: 2,
                cornerRadius: 10,
            });
            const circle_radius = 10;
            var falseCircle = new Konva.Circle({
                y: rect1.height(),
                x: 0,
                radius: circle_radius,
                fill: 'red',
                stroke: 'black',
            });
            var trueCircle = new Konva.Circle({
                y: rect1.height(),
                x: rect1.width(),
                radius: circle_radius,
                fill: 'green',
                stroke: 'black',
            });

            //this is an invisible circle used only for making a new connection between nodes
            this.trueDragCircle = new Konva.Circle({
                draggable: true,
                y: rect1.height(),
                x: rect1.width(),
                radius: circle_radius,
                fill: 'black',
                opacity: 0.5
            });
            this.trueDragCircle.originalX = this.trueDragCircle.x();
            this.trueDragCircle.originalY = this.trueDragCircle.y();

            this.inputCircle = new Konva.Circle({
                y: 0,
                x: rect1.width() / 2,
                radius: circle_radius,
                fill: 'white',
                stroke: 'black',
            });

            g.add(rect1);
            g.add(this.inputCircle);
            g.add(trueCircle);

            //when the invisible circle starts to be dragged create a new temporary arrow
            this.trueDragCircle.on("dragstart", function(){
                this.tempX = this.getAbsolutePosition().x;
                this.tempY = this.getAbsolutePosition().y;
                //it is important that the invisible circle is in a different layer in order to check what is under the cursor it later
                this.moveTo(templayer);
                this.tempArrow = new Konva.Arrow({
                    stroke: "black",
                    fill: "black"
                });
                layer.add(this.tempArrow);
            });

            //update the temporary arrow
            this.trueDragCircle.on("dragmove", function(){
                this.tempArrow.points([this.tempX, this.tempY, stage.getPointerPosition().x, stage.getPointerPosition().y]);
                layer.draw();
            });

            //when the drag is enden return the invisible circle to its original position, remove the temporary arrow and create a new connection between nodes if applicable
            this.trueDragCircle.on("dragend", function(){
                var touchPos = stage.getPointerPosition();
                var intersect = layer.getIntersection(touchPos);
                console.log(intersect);
                //TODO: shit doen hier

                this.moveTo(g);
                this.x(this.originalX);
                this.y(this.originalY);
                this.tempArrow.destroy();
                this.tempArrow = null;
                layer.draw();
                templayer.draw();
            });
            g.add(this.trueDragCircle);
            g.add(falseCircle);

            this.group = g;
        }
        dragStartCondRes(){
            this.trueDragCircle.moveTo(templayer);
        }
    }


    var node1 = new condition();
    var node2 = new condition();
    layer.add(node1.group);
    layer.add(node2.group);
    stage.add(layer);
    stage.add(templayer);

    // draw the image
    layer.draw();
</script>
</body>
</html>
